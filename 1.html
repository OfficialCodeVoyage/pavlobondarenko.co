<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Particles</title>
    <style>
        body { margin: 0; overflow: hidden;}
    </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/jsm/controls/OrbitControls.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/jsm/math/ImprovedNoise.js" defer></script>

<script defer>
    // Scene, Camera, Renderer setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Orbit Controls (Note: Now we have OrbitControls defined)
    const controls = new OrbitControls(camera, renderer.domElement);

    // Create tons of particles!
    const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
    const vertices = [];
    const colors = [];

    const color = new THREE.Color();
    const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');

    for (let i = 0; i < 10000; i++) {
        vertices.push(THREE.MathUtils.randFloatSpread(200));
        vertices.push(THREE.MathUtils.randFloatSpread(200));
        vertices.push(THREE.MathUtils.randFloatSpread(200));

        color.setHSL(i / 10000, 1.0, 0.5);
        colors.push(color.r, color.g, color.b);
    }

    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

    const material = new THREE.MeshBasicMaterial({ color: 0xffffff, vertexColors: true });

    const particles = new THREE.Mesh(geometry, material);
    scene.add(particles);

    camera.position.z = 5;

    // Mouse
    const mouse = new THREE.Vector2();
    window.addEventListener('mousemove', (event) => {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    });

    // Animation Loop
    function animate() {
        requestAnimationFrame(animate);

        particles.rotation.x += 0.001;
        particles.rotation.y += 0.003;

        const time = performance.now() * 0.0005;
        const noise = new ImprovedNoise(); // Assuming this works now

        const positions = particles.geometry.attributes.position.array;
        for (let i = 0; i < positions.length; i += 3) {
            const x = positions[i];
            const y = positions[i + 1];
            const z = positions[i + 2];

            const noiseValue = noise.noise(x * 0.1 + time, y * 0.1 + time, z * 0.1 + time);
            positions[i]   += noiseValue * 0.5;
            positions[i + 1] += noiseValue * 0.5;
            positions[i + 2] += noiseValue * 0.5;

            let dx = positions[i] - mouse.x * 2;
            let dy = positions[i + 1] - mouse.y * 2;
            let distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 2) {
                positions[i] += dx / distance * 0.2;
                positions[i + 1] += dy / distance * 0.2;
            }
        }
        particles.geometry.attributes.position.needsUpdate = true;

        renderer.render(scene, camera);
    }

    animate();
</script>
</body>
</html>
